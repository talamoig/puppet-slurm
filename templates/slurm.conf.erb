<%# slurm.conf.erb                                                           -%>
<%#                                                                          -%>
<%# Common SLURM parameters for db, head and worker node.                    -%>
<%#                                                                          -%>
<%# version 20170816                                                         -%>
<%#                                                                          -%>
<%# Copyright (c) CERN, 2016-2017                                            -%>
<%# Authors: - Philippe Ganz <phganz@cern.ch>                                -%>
<%#          - Carolina Lindqvist <calindqv@cern.ch>                         -%>
<%#          - Pablo Llopis <pablo.llopis@cern.ch>                           -%>
<%#          - Marc Caubet Serrabou <marc.caubet@psi.ch>                     -%>
<%# License: GNU GPL v3 or later.                                            -%>
<%#                                                                          -%>
# /etc/slurm/slurm.conf generated by puppet
#
# Configuration file containing common parameters for headnode and workernode.
#

# GENERAL OPTIONS
AllowSpecResourcesUsage=<%= @allow_spec_resources_usage %>
<% unless @checkpoint_type.nil? -%>CheckpointType=<%= @checkpoint_type %>
<% end -%>
<%= @chos_loc.nil? ? '#ChosLoc=' : ('ChosLoc=' + @chos_loc) %>
CoreSpecPlugin=<%= @core_spec_plugin %>
<% unless @communication_parameters.nil? -%>CommunicationParameters=<%= @communication_parameters.join(',') %>
<% end -%>
CpuFreqDef=<%= @cpu_freq_def %>
CpuFreqGovernors=<%= @cpu_freq_governors.join(',') %>
DisableRootJobs=<%= @disable_root_jobs %>
EnforcePartLimits=<%= @enforce_part_limits %>
ExtSensorsType=<%= @ext_sensors_type %>
ExtSensorsFreq=<%= @ext_sensors_freq %>
FirstJobId=<%= @first_job_id %>
MaxJobId=<%= @max_job_id %>
<%= @federation_parameters.nil? ? '#FederationParameters=' : ('FederationParameters=' + @federation_parameters.join(',')) %>
<%= @gres_types.nil? ? '#GresTypes=' : ('GresTypes=' + @gres_types.join(',')) %>
GroupUpdateForce=<%= @group_update_force %>
<% unless @job_checkpoint_dir.nil? -%>JobCheckpointDir=<%= @job_checkpoint_dir %>
<% end -%>
JobContainerType=<%= @job_container_type %>
JobFileAppend=<%= @job_file_append %>
JobRequeue=<%= @job_requeue %>
<%# comment out if empty, expand array if not                                -%>
<% if @job_submit_plugins.nil? -%>
#JobSubmitPlugins=
<% else -%>
JobSubmitPlugins=<%= @job_submit_plugins.join(',') %>
<% end -%>
<%#                                                                          -%>
KillOnBadExit=<%= @kill_on_bad_exit %>
LaunchType=<%= @launch_type %>
<%# comment out if empty, expand array if not                                -%>
<% if @launch_parameters.nil? -%>
#LaunchParameters=
<% else -%>
LaunchParameters=<%= @launch_parameters.join(',') %>
<% end -%>
<%#                                                                          -%>
<%= @licenses.nil? ? '#Licenses=' : ('Licenses=' + @licenses) %>
<%= @node_features_plugins.nil? ? '#NodeFeaturesPlugins=' : ('NodeFeaturesPlugins=' + @node_features_plugins) %>
MailProg=<%= @mail_prog %>
<%= @mail_domain.nil? ? '#MailDomain=' : ('MailDomain=' + @mail_domain) %>
MaxJobCount=<%= @max_job_count %>
MaxStepCount=<%= @max_step_count %>
<% unless @mem_limit_enforce.nil? -%>MemLimitEnforce=<%= @mem_limit_enforce %>
<% end -%>
<% unless @msg_aggregation_params.nil? -%>MsgAggregationParams=<%= @msg_aggregation_params.map{|pair| pair.join('=')}.join(',') %>
<% end -%>
<% unless @plugin_dir.nil? -%>PluginDir=<%= @plugin_dir %>
<% end -%>
<%= @plug_stack_config.nil? ? '#PlugStackConfig=' : ('PlugStackConfig=' + @plug_stack_config) %>
PowerPlugin=<%= @power_plugin %>
<%# comment out if empty, expand array if not                                -%>
<% if @power_parameters.nil? -%>
#PowerParameters=
<% else -%>
PowerParameters=<%= @power_parameters.join(',') %>
<% end -%>
<%#                                                                          -%>
PreemptType=<%= @preempt_type %>
<%# comment out if empty, expand array if not                                -%>
<% if @preempt_mode.nil? -%>
#PreemptMode=
<% else -%>
PreemptMode=<%= @preempt_mode.join(',') %>
<% end -%>
<%#                                                                          -%>
<%# comment out if empty, expand array if not                                -%>
<% if @private_data.nil? -%>
#PrivateData=
<% else -%>
PrivateData=<%= @private_data.join(',') %>
<% end -%>
<%#                                                                          -%>
<%= @proctrack_type.nil? ? '#ProctrackType=' : ('ProctrackType=' + @proctrack_type) %>
PropagatePrioProcess=<%= @propagate_prio_process %>
<%# comment out if empty, expand array if not                                -%>
<% if @propagate_resource_limits.nil? -%>
#PropagateResourceLimits=
<% else -%>
PropagateResourceLimits=<%= @propagate_resource_limits.join(',') %>
<% end -%>
<%#                                                                          -%>
<%# comment out if empty, expand array if not                                -%>
<% if @propagate_resource_limits_except.nil? -%>
#PropagateResourceLimitsExcept=
<% else -%>
PropagateResourceLimitsExcept=<%= @propagate_resource_limits_except.join(',') %>
<% end -%>
<%#                                                                          -%>
<%= @reboot_program.nil? ? '#RebootProgram=' : ('RebootProgram=' + @reboot_program) %>
<%= @reconfig_flags.nil? ? '#ReconfigFlags=' : ('ReconfigFlags=' + @reconfig_flags) %>
<%= @resv_epilog.nil? ? '#ResvEpilog=' : ('ResvEpilog=' + @resv_epilog) %>
<%= @resv_prolog.nil? ? '#ResvProlog=' : ('ResvProlog=' + @resv_prolog) %>
ReturnToService=<%= @return_to_service %>
<%= @salloc_default_command.nil? ? '#SallocDefaultCommand=' : ('SallocDefaultCommand=' + @salloc_default_command) %>
<%# comment out if empty, expand hash if not                                 -%>
<% if @sbcast_parameters.nil? -%>
#SbcastParameters=
<% else -%>
SbcastParameters=<%= @sbcast_parameters.map{|pair| pair.join('=')}.join(',') %>
<% end -%>
<%# SLURMCTLD GENERAL OPTIONS                                                -%>
<% unless @max_dbd_msgs.nil? -%>
MaxDBDMsgs=<%= @max_dbd_msgs.to_s %>
<% end -%>
<%= @slurmctld_addr.nil? ? '#SlurmctldAddr=' : ('SlurmctldAddr=' + @slurmctld_addr) %>
<% unless @slurmctld_host.nil? -%>
<% @slurmctld_host.each do |slurmctld| -%>
SlurmctldHost=<%= slurmctld %>
<% end -%>
<% else %>
#SlurmctldHost=
<% unless @control_machine.nil? -%>
ControlMachine=<%= @control_machine %> # Deprecated option, see SlurmctldHost
<% end -%>
<% unless @control_addr.nil? -%>
ControlAddr=<%= @control_addr %> # Deprecated option, see SlurmctldHost
<% end -%>
<% unless @backup_controller.nil? -%>
BackupController=<%= @backup_controller %> # Deprecated option, see SlurmctldHost
<% end -%>
<% unless @backup_addr.nil? -%>
BackupAddr=<%= @backup_addr %> # Deprecated option, see SlurmctldHost
<% end -%>
<% end -%>
SlurmctldPidFile=<%= @slurmctld_pid_file %>
<%= @slurmctld_plugstack.nil? ? '#SlurmctldPlugstack=' : ('SlurmctldPlugstack=' + @slurmctld_plugstack.join(',')) %>
SlurmctldPort=<%= @slurmctld_port %>
<%= @slurmctld_parameters.nil? ? '#SlurmctldParameters=' : ('SlurmctldParameters=' + @slurmctld_parameters.join(',')) %>
<%= @slurmctld_primary_off_prog.nil? ? '#SlurmctldPrimaryOffProg=' : ('SlurmctldPrimaryOffProg=' + @slurmctld_primary_off_prog) %>
<%= @slurmctld_primary_on_prog.nil? ? '#SlurmctldPrimaryOnProg=' : ('SlurmctldPrimaryOnProg=' + @slurmctld_primary_on_prog) %>
<%# SLURMD GENERAL OPTIONS                                                   -%>
SlurmdPidFile=<%= @slurmd_pid_file %>
<%= @slurmd_plugstack.nil? ? '#SlurmdPlugstack=' : ('SlurmdPlugstack=' + @slurmd_plugstack.join(',')) %>
SlurmdPort=<%= @slurmd_port %>
SlurmdSpoolDir=<%= @slurmd_spool_dir %>
SlurmUser=<%= @slurm_user %>
SlurmdUser=<%= @slurmd_user %>
<%# SRUN GENERAL OPTIONS                                                     -%>
<%= @srun_epilog.nil? ? '#SrunEpilog=' : ('SrunEpilog=' + @srun_epilog) %>
<%= @srun_prolog.nil? ? '#SrunProlog=' : ('SrunProlog=' + @srun_prolog) %>
<%= @srun_port_range.nil? ? '#SrunPortRange=' : ('SrunPortRange=' + @srun_port_range) %>
StateSaveLocation=<%= @state_save_location %>
SwitchType=<%= @switch_type %>
TaskPlugin=<%= @task_plugin.join(',') %>
<%= @task_plugin_param.nil? ? '#TaskPluginParam=' : ('TaskPluginParam=' + @task_plugin_param.join(',')) %>
<%#                                                                          -%>
<%= @task_epilog.nil? ? '#TaskEpilog=' : ('TaskEpilog=' + @task_epilog) %>
<%= @task_prolog.nil? ? '#TaskProlog=' : ('TaskProlog=' + @task_prolog) %>
TCPTimeout=<%= @tcp_timeout %>
TmpFS=<%= @tmp_fs %>
TrackWCKey=<%= @track_wckey %>
<%= @unkillable_step_program.nil? ? '#UnkillableStepProgram=' : ('UnkillableStepProgram=' + @unkillable_step_program) %>


# SECURITY
<%= @auth_alt_type.nil? ? '#AuthAltTypes=' : ( 'AuthAltTypes=' + @auth_alt_type.join(',')) %>
<%= @auth_alt_parameters.nil? ? '#AuthAltParameters=' : ( 'AuthAltParameters=' + @auth_alt_parameters.join(',')) %>
<%= @auth_info.nil? ? '#AuthInfo=' : ( 'AuthInfo=' + @auth_info) %>
AuthType=<%= @auth_type %>
<%= @auth_info.nil? ? '#AuthInfo=' : ('AuthInfo=' + @auth_info) %>
CryptoType=<%= @crypto_type %>
<%= @job_credential_private_key.nil? ? '#JobCredentialPrivateKey=' : ('JobCredentialPrivateKey=' + @job_credential_private_key) %>
<%= @job_credential_public_certificate.nil? ? '#JobCredentialPublicCertificate=' : ('JobCredentialPublicCertificate=' + @job_credential_public_certificate) %>
MCSPlugin=<%= @mcs_plugin %>
<%= @mcs_parameters.nil? ? '#MCSParameters=' : ('MCSParameters=' + @mcs_parameters) %>
UsePAM=<%= @use_pam %>


# TIMERS
BatchStartTimeout=<%= @batch_start_timeout %>
CompleteWait=<%= @complete_wait %>
EioTimeout=<%= @eio_timeout %>
EpilogMsgTime=<%= @epilog_msg_time %>
GetEnvTimeout=<%= @get_env_timeout %>
GroupUpdateTime=<%= @group_update_time %>
InactiveLimit=<%= @inactive_limit %>
<%= @keep_alive_time==0 ? '#KeepAliveTime=' : ('KeepAliveTime=' + @keep_alive_time.to_s) %>
KillWait=<%= @kill_wait %>
MessageTimeout=<%= @message_timeout %>
MinJobAge=<%= @min_job_age %>
OverTimeLimit=<%= @over_time_limit %>
PrologEpilogTimeout=<%= @prolog_epilog_timeout %>
ResvOverRun=<%= @resv_over_run %>
SlurmctldTimeout=<%= @slurmctld_timeout %>
SlurmdTimeout=<%= @slurmd_timeout %>
UnkillableStepTimeout=<%= @unkillable_step_timeout %>
Waittime=<%= @wait_time %>


# SCHEDULING
<%= @def_cpu_per_gpu.nil? ? '#DefCpuPerGPU=' : ('DefCpuPerGPU=' + @def_cpu_per_gpu.to_s) %>
<%= @def_mem_per_cpu==0 ? '#DefMemPerCPU=' : ('DefMemPerCPU=' + @def_mem_per_cpu.to_s) %>
<%= @def_mem_per_gpu==0 ? '#DefMemPerGPU=' : ('DefMemPerGPU=' + @def_mem_per_gpu.to_s) %>
<%= @def_mem_per_node==0 ? '#DefMemPerNode=' : ('DefMemPerNode=' + @def_mem_per_node.to_s) %>
<%= @epilog.nil? ? '#Epilog=' : ('Epilog=' + @epilog) %>
<%= @epilog_slurmctld.nil? ? '#EpilogSlurmctld=' : ('EpilogSlurmctld=' + @epilog_slurmctld) %>
<% unless @fast_schedule.nil? -%>FastSchedule=<%= @fast_schedule %>
<% end -%>
MaxArraySize=<%= @max_array_size %>
MaxMemPerCPU=<%= @max_mem_per_cpu %>
MaxMemPerNode=<%= @max_mem_per_node %>
MaxTasksPerNode=<%= @max_tasks_per_node %>
MpiDefault=<%= @mpi_default %>
<%= @mpi_params.nil? ? '#MpiParams=' : ('MpiParams=' + @mpi_params) %>
<%= @prolog_slurmctld.nil? ? '#PrologSlurmctld=' : ('PrologSlurmctld=' + @prolog_slurmctld) %>
<%= @prolog.nil? ? '#Prolog=' : ('Prolog=' + @prolog) %>
<%# comment out if empty, expand array if not                                -%>
<% if @prolog_flags.nil? -%>
#PrologFlags=
<% else -%>
PrologFlags=<%= @prolog_flags.join(',') %>
<% end -%>
<% if @x11_parameters.nil? -%>
#X11Parameters=
<% else -%>
X11Parameters=<%= @x11_parameters.join(',') %>
<% end -%>
<%#                                                                          -%>
<%= @requeue_exit.nil? ? '#RequeueExit=' : ('RequeueExit=' + @requeue_exit) %>
<%= @requeue_exit_hold.nil? ? '#RequeueExitHold=' : ('RequeueExitHold=' + @requeue_exit_hold) %>
SchedulerTimeSlice=<%= @scheduler_time_slice %>
SchedulerType=<%= @scheduler_type %>
<%# comment out if empty, expand array if not                                -%>
<% if @scheduler_parameters.nil? -%>
#SchedulerParameters=
<% else -%>
SchedulerParameters=<%= @scheduler_parameters.join(',') %>
<% end -%>
<%#                                                                          -%>
SelectType=<%= @select_type %>
<%= @select_type_parameters.nil? ? '#SelectTypeParameters=' : ('SelectTypeParameters=' + @select_type_parameters.join(',')) %>
VSizeFactor=<%= @vsize_factor %>


# JOB PRIORITY
PriorityType=<%= @priority_type %>
<%# comment out if empty, expand array if not                                -%>
<% if @priority_flags.nil? -%>
#PriorityFlags=
<% else -%>
PriorityFlags=<%= @priority_flags.join(',') %>
<% end -%>
<%#                                                                          -%>
PriorityCalcPeriod=<%= @priority_calc_period %>
PriorityDecayHalfLife=<%= @priority_decay_half_life %>
PriorityFavorSmall=<%= @priority_favor_small %>
PriorityMaxAge=<%= @priority_max_age %>
PriorityUsageResetPeriod=<%= @priority_usage_reset_period %>
PriorityWeightAge=<%= @priority_weight_age %>
PriorityWeightFairshare=<%= @priority_weight_fairshare %>
FairShareDampeningFactor=<%= @fair_share_dampening_factor %>
PriorityWeightJobSize=<%= @priority_weight_job_size %>
PriorityWeightPartition=<%= @priority_weight_partition %>
PriorityWeightQOS=<%= @priority_weight_qos %>
<%# comment out if empty, process hash otherwise                             -%>
<% if @priority_weight_tres.nil? -%>
#PriorityWeightTRES=
<% else -%>
PriorityWeightTRES=<%= @priority_weight_tres.map{|pair| pair.join('=')}.join(',') %>
<% end -%>
<%#                                                                          -%>


# ACCOUNTING
<%= @cluster_name.nil? ? '#ClusterName=' : ('ClusterName=' + @cluster_name) %>
<% unless @default_storage_host.nil? -%>DefaultStorageHost=<%= @default_storage_host %>
<% end -%>
<% unless @default_storage_port.nil? -%>DefaultStoragePort=<%= @default_storage_port %>
<% end -%>
<% unless @default_storage_type.nil? -%>DefaultStorageType=<%= @default_storage_type %>
<% end -%>
<% unless @default_storage_user.nil? -%>DefaultStorageUser=<%= @default_storage_user %>
<% end -%>
<% unless @default_storage_pass.nil? -%>DefaultStoragePass=<%= @default_storage_pass %>
<% end -%>
<% unless @default_storage_loc.nil? -%>DefaultStorageLoc=<%= @default_storage_loc %>
<% end -%>
<%= @accounting_storage_host.nil? ? '#AccountingStorageHost=' : ('AccountingStorageHost=' + @accounting_storage_host) %>
<%= @accounting_storage_backup_host.nil? ? '#AccountingStorageBackupHost=' : ('AccountingStorageBackupHost=' + @accounting_storage_backup_host) %>
AccountingStoragePort=<%= @accounting_storage_port %>
<%= @accounting_storage_enforce.nil? ? '#AccountingStorageEnforce=' : ('AccountingStorageEnforce=' + @accounting_storage_enforce) %>
<%# comment out if empty, expand array if not                                -%>
<% if @accounting_storage_tres.nil? -%>
#AccountingStorageTRES=
<% else -%>
AccountingStorageTRES=<%= @accounting_storage_tres.join(',') %>
<% end -%>
<%#                                                                          -%>
AccountingStorageType=<%= @accounting_storage_type %>
<%= @accounting_storage_user.nil? ? '#AccountingStorageUser=' : ('AccountingStorageUser=' + @accounting_storage_user) %>
<%= @accounting_storage_pass.nil? ? '#AccountingStoragePass=' : ('AccountingStoragePass=' + @accounting_storage_pass) %>
<%= @accounting_storage_loc.nil? ? '#AccountingStorageLoc=' : ('AccountingStorageLoc=' + @accounting_storage_loc) %>
<% unless @accounting_store_jobhost.nil? -%>AccountingStoreJobComment=<%= @accounting_store_jobhost %>
<% end -%>
<% unless @accounting_store_flags.nil? -%>AccountingStoreFlags=<%= @accounting_store_flags.join(',') %>
<% end -%>
JobCompType=<%= @job_comp_type %>
<%= @job_comp_host.nil? ? '#JobCompHost=' : ('JobCompHost=' + @job_comp_host) %>
JobCompPort=<%= @job_comp_port %>
<%= @job_comp_user.nil? ? '#JobCompUser=' : ('JobCompUser=' + @job_comp_user) %>
<%= @job_comp_pass.nil? ? '#JobCompPass=' : ('JobCompPass=' + @job_comp_pass) %>
<%= @job_comp_loc.nil? ? '#JobCompLoc=' : ('JobCompLoc=' + @job_comp_loc) %>
JobAcctGatherType=<%= @job_acct_gather_type %>
<%# comment out if empty, expand array if not                                -%>
<% if @job_acct_gather_params.nil? -%>
#JobAcctGatherParams=
<% else -%>
JobAcctGatherParams=<%= @job_acct_gather_params.join(',') %>
<% end -%>
<%#                                                                          -%>
<%# comment out if empty, process hash otherwise                             -%>
<% if @job_acct_gather_frequency.nil? -%>
#JobAcctGatherFrequency=
<% else -%>
JobAcctGatherFrequency=<%= @job_acct_gather_frequency.map{|pair| pair.join('=')}.join(',') %>
<% end -%>
<%#                                                                          -%>
AcctGatherNodeFreq=<%= @acct_gather_node_freq %>
AcctGatherEnergyType=<%= @acct_gather_energy_type %>
<% if @acct_gather_interconnect_type =="acct_gather_infiniband/ofed" -%>
AcctGatherInfinibandType=<%= @acct_gather_interconnect_type %>
<% elsif @acct_gather_interconnect_type == "acct_gather_interconnect/ofed" -%>
AcctGatherInterconnectType=<%= @acct_gather_interconnect_type %>
<% else -%>
AcctGatherInterconnectType=acct_gather_interconnect/none
<% end -%>
AcctGatherFilesystemType=<%= @acct_gather_filesystem_type %>
AcctGatherProfileType=<%= @acct_gather_profile_type %>


# LOGGING
<%# comment out if empty, expand array if not                                -%>
<% if @debug_flags.nil? -%>
#DebugFlags=
<% else -%>
DebugFlags=<%= @debug_flags.join(',') %>
<% end -%>
<%#                                                                          -%>
LogTimeFormat=<%= @log_time_format %>
SlurmctldDebug=<%= @slurmctld_debug %>
<% unless @slurmctld_syslog_debug.nil? -%>SlurmctldSyslogDebug=<%= @slurmctld_syslog_debug %>
<% end -%>
<%= @slurmctld_log_file.nil? ? '#SlurmctldLogFile=' : ('SlurmctldLogFile=' + @slurmctld_log_file) %>
SlurmdDebug=<%= @slurmd_debug %>
<% if @slurmd_syslog_debug -%>
SlurmdSyslogDebug=<%= @slurmd_syslog_debug %>
<% end -%>
<%= @slurmd_log_file.nil? ? '#SlurmdLogFile=' : ('SlurmdLogFile=' + @slurmd_log_file) %>
SlurmSchedLogLevel=<%= @slurm_sched_log_level %>
<%= @slurm_sched_log_file.nil? ? '#SlurmSchedLogFile=' : ('SlurmSchedLogFile=' + @slurm_sched_log_file) %>


# HEALTH CHECK
<%= @health_check_program.nil? ? '#HealthCheckProgram=' : ('HealthCheckProgram=' + @health_check_program) %>
HealthCheckNodeState=<%= @health_check_node_state %>
HealthCheckInterval=<%= @health_check_interval %>


# POWER SAVE SUPPORT FOR IDLE NODES
<%= @suspend_program.nil? ? '#SuspendProgram=' : ('SuspendProgram=' + @suspend_program) %>
SuspendTimeout=<%= @suspend_timeout %>
SuspendRate=<%= @suspend_rate %>
SuspendTime=<%= @suspend_time %>
<%= @suspend_exc_nodes.nil? ? '#SuspendExcNodes=' : ('SuspendExcNodes=' + @suspend_exc_nodes) %>
<%= @suspend_exc_parts.nil? ? '#SuspendExcParts=' : ('SuspendExcParts=' + @suspend_exc_parts) %>
<%= @resume_program.nil? ? '#ResumeProgram=' : ('ResumeProgram=' + @resume_program) %>
ResumeTimeout=<%= @resume_timeout %>
ResumeRate=<%= @resume_rate %>


# TOPOLOGY
TopologyPlugin=<%= @topology_plugin %>
<%# comment out if empty, expand array if not                                -%>
<% if @topology_param.nil? -%>
#TopologyParam=
<% else -%>
TopologyParam=<%= @topology_param.join(',') %>
<% end -%>
<%#                                                                          -%>
RoutePlugin=<%= @route_plugin %>
TreeWidth=<%= @tree_width %>

# COMPUTE NODES
<% @workernodes.each do |workernode| -%>
<%= workernode.map{|pair| pair.join('=')}.join(' ') %>
<% end -%>


# NODE SETS
<% unless @nodesets.nil? -%>
<% @nodesets.each do |nodeset| -%>
<%= nodeset.map{|pair| pair.join('=')}.join(' ') %>
<% end -%>
<% end -%>


# PARTITIONS
<% @partitions.each do |partition| -%>
<%= partition.map{|pair| pair.join('=')}.join(' ') %>
<% end -%>
